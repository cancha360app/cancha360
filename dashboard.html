<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Cancha360</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <h1>Bienvenido a tu Dashboard ‚öΩ</h1>
    <p id="user-info"></p>

    <!-- Botones de acci√≥n -->
    <div class="mb-4">
      <a href="create-match.html" class="btn btn-success me-2">‚ûï Crear Partido</a>
      <a href="create-court.html" id="admin-create-court" class="btn btn-primary d-none">üèüÔ∏è Crear Cancha</a>
    </div>

    <!-- Partidos del usuario -->
    <h3>Tus partidos</h3>
    <ul id="reservas-list" class="list-group mb-4"></ul>

    <!-- Lista de partidos disponibles -->
    <h3 class="mt-4">Partidos disponibles</h3>
    <ul id="partidos-disponibles" class="list-group mb-4"></ul>

    <button id="logout" class="btn btn-danger">Cerrar sesi√≥n</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
  const SUPABASE_URL = "https://rcpwypqzahsfsudlkwaf.supabase.co";
  const SUPABASE_KEY = "TU_API_KEY"; 
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;

  async function checkSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = "login.html";
    } else {
      currentUser = session.user;
      document.getElementById("user-info").textContent =
        `Has iniciado sesi√≥n como: ${currentUser.email}`;

      const { data: userData } = await supabase
        .from("usuarios")
        .select("rol")
        .eq("id", currentUser.id)
        .single();

      if (userData && userData.rol === "admin") {
        document.getElementById("admin-create-court").classList.remove("d-none");
      }

      loadReservas();
      loadPartidosDisponibles();
    }
  }

  // Tus partidos
  async function loadReservas() {
    const { data, error } = await supabase
      .from("reservas_usuarios")
      .select("reserva_id, reservas(*, canchas(nombre))")
      .eq("usuario_id", currentUser.id);

    const lista = document.getElementById("reservas-list");
    lista.innerHTML = "";

    if (error) {
      lista.innerHTML = `<li class="list-group-item text-danger">Error: ${error.message}</li>`;
      return;
    }

    if (!data || data.length === 0) {
      lista.innerHTML = `<li class="list-group-item">No est√°s anotado en ning√∫n partido</li>`;
      return;
    }

    data.forEach(r => {
      const partido = r.reservas;
      const item = document.createElement("li");
      item.className = "list-group-item";
      item.textContent = `${partido.canchas.nombre} - ${partido.fecha} ${partido.hora_inicio}-${partido.hora_fin}`;
      lista.appendChild(item);
    });
  }

  // Partidos disponibles
  async function loadPartidosDisponibles() {
    const { data: reservas, error } = await supabase
      .from("reservas")
      .select("id, fecha, hora_inicio, hora_fin, cupo_actual, cupo_max, canchas(nombre)");

    if (error) {
      console.error("Error cargando reservas:", error.message);
      return;
    }

    const { data: misPartidos } = await supabase
      .from("reservas_usuarios")
      .select("reserva_id")
      .eq("usuario_id", currentUser.id);

    const idsOcupados = misPartidos ? misPartidos.map(r => r.reserva_id) : [];

    const disponibles = reservas.filter(r =>
      !idsOcupados.includes(r.id) && r.cupo_actual < r.cupo_max
    );

    const lista = document.getElementById("partidos-disponibles");
    lista.innerHTML = "";

    if (disponibles.length === 0) {
      lista.innerHTML = `<li class="list-group-item">No hay partidos disponibles</li>`;
      return;
    }

    disponibles.forEach(r => {
      const item = document.createElement("li");
      item.className = "list-group-item d-flex justify-content-between align-items-center";
      item.innerHTML = `
        <span>${r.canchas.nombre} - ${r.fecha} ${r.hora_inicio} | Cupo: ${r.cupo_actual}/${r.cupo_max}</span>
        <button class="btn btn-sm btn-primary">Unirme</button>
      `;

      item.querySelector("button").addEventListener("click", async () => {
        const { error } = await supabase
          .from("reservas_usuarios")
          .insert([{ reserva_id: r.id, usuario_id: currentUser.id }]);

        if (error) {
          if (error.message.includes("duplicate key")) {
            alert("‚ö†Ô∏è Ya est√°s unido a este partido.");
          } else {
            alert("‚ùå Error al unirse: " + error.message);
          }
        } else {
          await supabase
            .from("reservas")
            .update({ cupo_actual: r.cupo_actual + 1 })
            .eq("id", r.id);

          alert("‚úÖ Te uniste al partido!");
          loadReservas();
          loadPartidosDisponibles();
        }
      });

      lista.appendChild(item);
    });
  }

  document.getElementById("logout").addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  });

  checkSession();
  </script>
</body>
</html>
