<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Cancha360</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">Cancha360</a>
      <div class="d-flex align-items-center">
        <span id="user-name" class="me-3 fw-semibold"></span>
        <a href="perfil.html">
          <img id="user-avatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNlZWUiIC8+PC9zdmc+" alt="Avatar" class="avatar">
        </a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h1>Bienvenido a tu Dashboard ‚öΩ</h1>

    <!-- Botones -->
    <div class="mb-4">
      <a href="create-match.html" class="btn btn-success me-2">‚ûï Crear Partido</a>
      <a href="create-court.html" id="admin-create-court" class="btn btn-primary d-none">üèüÔ∏è Crear Cancha</a>
    </div>

    <!-- Tus partidos -->
    <h3>Tus partidos</h3>
    <ul id="reservas-list" class="list-group mb-4"></ul>

    <!-- Partidos disponibles -->
    <h3 class="mt-4">Partidos disponibles</h3>
    <ul id="partidos-disponibles" class="list-group mb-4"></ul>

    <button id="logout" class="btn btn-danger">Cerrar sesi√≥n</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
  const SUPABASE_URL = "https://rcpwypqzahsfsudlkwaf.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjcHd5cHF6YWhzZnN1ZGxrd2FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MTQwODIsImV4cCI6MjA3NDQ5MDA4Mn0.VPkdTAhTK_tZ6Re_lcdx5E3oxSDS2oYG8YDSATXtcl4"; 
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUser = null;

  async function checkSession() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      window.location.href = "login.html";
      return;
    }

    currentUser = session.user;
    console.log("Usuario actual:", currentUser.id);

    const { data: userData } = await supabase
      .from("usuarios")
      .select("nombre, avatar_url, rol")
      .eq("id", currentUser.id)
      .single();

    // Nombre
    let nombre = userData?.nombre || currentUser.user_metadata?.full_name || currentUser.email;
    document.getElementById("user-name").textContent = nombre;

    // Avatar
    let avatarUrl = userData?.avatar_url || currentUser.user_metadata?.avatar_url ||
      "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiNlZWUiIC8+PC9zdmc+";
    document.getElementById("user-avatar").src = avatarUrl;

    if (userData?.rol === "admin") {
      document.getElementById("admin-create-court").classList.remove("d-none");
    }

    loadReservas();
    loadPartidosDisponibles();
  }

  // Tus partidos
  async function loadReservas() {
    const { data, error } = await supabase
      .from("reservas_usuarios")
      .select("reserva_id, reservas(*, canchas(nombre))")
      .eq("usuario_id", currentUser.id);

    const lista = document.getElementById("reservas-list");
    lista.innerHTML = "";

    if (error) {
      lista.innerHTML = `<li class="list-group-item text-danger">Error: ${error.message}</li>`;
      return;
    }

    if (!data || data.length === 0) {
      lista.innerHTML = `<li class="list-group-item">No est√°s anotado en ning√∫n partido</li>`;
      return;
    }

    data.forEach(r => {
      const partido = r.reservas;
      const item = document.createElement("li");
      item.className = "list-group-item";
      item.textContent = `${partido.canchas.nombre} - ${partido.fecha} ${partido.hora_inicio}-${partido.hora_fin} | Cupo: ${partido.cupo_actual}/${partido.cupo_max}`;
      lista.appendChild(item);
    });
  }

  // Partidos disponibles
  async function loadPartidosDisponibles() {
    const { data: reservas, error } = await supabase
      .from("reservas")
      .select("id, fecha, hora_inicio, hora_fin, cupo_actual, cupo_max, usuario_id, canchas(nombre)");

    if (error) {
      console.error("Error cargando reservas:", error.message);
      return;
    }

    const { data: misPartidos } = await supabase
      .from("reservas_usuarios")
      .select("reserva_id")
      .eq("usuario_id", currentUser.id);

    const idsOcupados = misPartidos ? misPartidos.map(r => r.reserva_id) : [];

    const disponibles = reservas.filter(r => {
      console.log("Reserva:", r.id, "creador:", r.usuario_id, "cupo:", r.cupo_actual, "/", r.cupo_max);
      return (
        r.usuario_id !== currentUser.id &&       // no mostrar los que yo mismo cre√©
        !idsOcupados.includes(r.id) &&           // no mostrar si ya estoy anotado
        r.cupo_actual < r.cupo_max               // solo si hay lugar
      );
    });

    const lista = document.getElementById("partidos-disponibles");
    lista.innerHTML = "";

    if (disponibles.length === 0) {
      lista.innerHTML = `<li class="list-group-item">No hay partidos disponibles</li>`;
      return;
    }

    disponibles.forEach(r => {
      const item = document.createElement("li");
      item.className = "list-group-item d-flex justify-content-between align-items-center";
      item.innerHTML = `
        <span>${r.canchas.nombre} - ${r.fecha} ${r.hora_inicio} | Cupo: ${r.cupo_actual}/${r.cupo_max}</span>
        <button class="btn btn-sm btn-primary">Unirme</button>
      `;

      item.querySelector("button").addEventListener("click", async () => {
        const { error } = await supabase
          .from("reservas_usuarios")
          .insert([{ reserva_id: r.id, usuario_id: currentUser.id }]);

        if (error) {
          alert("‚ùå Error al unirse: " + error.message);
          return;
        }

        // Actualizar cupo_actual
        await supabase
          .from("reservas")
          .update({ cupo_actual: r.cupo_actual + 1 })
          .eq("id", r.id);

        alert("‚úÖ Te uniste al partido");
        loadPartidosDisponibles();
        loadReservas();
      });

      lista.appendChild(item);
    });
  }

  document.getElementById("logout").addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "login.html";
  });

  checkSession();
  </script>
</body>
</html>
