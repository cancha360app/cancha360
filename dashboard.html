<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Partidos</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h1>Dashboard</h1>
  <p id="usuario"></p>

  <h2>Mis Partidos</h2>
  <ul id="misPartidos"></ul>

  <h2>Partidos Disponibles</h2>
  <ul id="partidosDisponibles"></ul>

  <script>
    // ğŸ”‘ Configura tu Supabase
    const supabaseUrl = "https://TU-PROJECT.supabase.co";
    const supabaseKey = "TU-CLAVE-ANON";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let usuarioId = null;

    // âœ… Cargar sesiÃ³n y usuario
    async function cargarSesion() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        console.error("âŒ SesiÃ³n invÃ¡lida, redirigiendo a login.html");
        window.location.href = "login.html";
        return;
      }
      usuarioId = user.id;
      console.log("âœ… SesiÃ³n iniciada como:", usuarioId);
      document.getElementById("usuario").innerText = "Usuario: " + usuarioId;
      cargarReservas();
    }

    // âœ… Cargar reservas (mis partidos y disponibles)
    async function cargarReservas() {
      // Todas las reservas
      let { data: reservas, error } = await supabase.from("reservas").select("*");
      if (error) {
        console.error("âŒ Error al cargar reservas:", error.message);
        return;
      }

      console.log("ğŸ“Œ Reservas encontradas:", reservas);

      // Mis partidos (reservas creadas por mÃ­ o donde estoy anotado)
      const { data: misReservas } = await supabase
        .from("reservas_usuarios")
        .select("reserva_id")
        .eq("usuario_id", usuarioId);

      const idsMisReservas = misReservas.map(r => r.reserva_id);
      console.log("ğŸ“Œ Mis reservas IDs:", idsMisReservas);

      const misPartidos = reservas.filter(r =>
        r.usuario_id === usuarioId || idsMisReservas.includes(r.id)
      );

      const partidosDisponibles = reservas.filter(r =>
        r.usuario_id !== usuarioId && !idsMisReservas.includes(r.id)
      );

      console.log("ğŸ“Œ Mis partidos:", misPartidos);
      console.log("ğŸ“Œ Partidos disponibles:", partidosDisponibles);

      renderizarLista("misPartidos", misPartidos, false);
      renderizarLista("partidosDisponibles", partidosDisponibles, true);
    }

    // âœ… Renderizar listas
    function renderizarLista(elementId, reservas, permitirUnirse) {
      const contenedor = document.getElementById(elementId);
      contenedor.innerHTML = "";

      if (reservas.length === 0) {
        contenedor.innerHTML = "<li>No hay partidos.</li>";
        return;
      }

      reservas.forEach(r => {
        const li = document.createElement("li");
        li.textContent = `Partido #${r.id} - ${r.fecha} ${r.hora_inicio} | ${r.cupo_actual}/${r.cupo_max}`;

        if (permitirUnirse) {
          const btn = document.createElement("button");
          btn.textContent = "Unirse";
          btn.onclick = () => unirseAReserva(r.id);
          li.appendChild(btn);
        }

        contenedor.appendChild(li);
      });
    }

    // âœ… Unirse a un partido
    async function unirseAReserva(reservaId) {
      console.log("ğŸ‘‰ Intentando unir usuario", usuarioId, "a la reserva", reservaId);

      // 1. Insertar en reservas_usuarios
      const { error: joinError } = await supabase
        .from("reservas_usuarios")
        .insert([{ reserva_id: reservaId, usuario_id: usuarioId }]);

      if (joinError) {
        console.error("âŒ Error al unirse:", joinError.message);
        alert("âŒ Error al unirse: " + joinError.message);
        return;
      }
      console.log("âœ… Usuario unido en reservas_usuarios");

      // 2. Incrementar contador en reservas
      const { data, error: updateError } = await supabase
        .from("reservas")
        .update({})
        .eq("id", reservaId)
        .increment("cupo_actual", 1);

      if (updateError) {
        console.error("âŒ Error al actualizar cupo:", updateError.message);
        alert("âŒ Error al actualizar cupo: " + updateError.message);
        return;
      }

      console.log("âœ… Cupo actualizado:", data);

      // 3. Refrescar listas
      cargarReservas();
    }

    // Iniciar
    cargarSesion();
  </script>
</body>
</html>
